# 一. 小程序的双线程模型

---

- 谁是小程序的宿主环境呢？微信客户端

- 宿主环境为了执行小程序的各种文件：`wxml`文件、`wxss`文件、`js`文件

- 当小程序基于`WebView`环境下时，`WebView`的`JS`逻辑、`DOM`树创建、`CSS`解析、样式计算、`Layout`、`Paint `(`Composite`)都发生在同一线程，在` WebView `上执行过多的` JS `逻辑可能阻塞渲染，导致界面卡顿
- 以此为前提，小程序同时考虑了性能与安全，采用了目前称为双线程模型的架构
- **双线程模型**：
  - `WXML`模块和`WXSS`样式运行于渲染层，**渲染层使用`WebView`线程渲染**（**一个程序有多个页面，会使用多个`WebView`的线程**）
  - `JS`脚本（`app.js/home.js`等）运行于逻辑层，**逻辑层使用`JsCore`运行JS脚本**
  - 这两个线程都会经由微信客户端（`Native`）进行中转交互

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819182359447.png" alt="image-20220819182359447"  />





# 二. 不同配置文件的区分

---

- 小程序的很多开发需求被规定在了配置文件中

- 为什么这样做呢?
  - 这样做可以更有利于我们的开发效率
  - 并且可以保证开发出来的小程序的某些风格是比较一致的
  - 比如导航栏 – 顶部`TabBar`，以及页面路由等等
- 常见的配置文件有哪些呢?
  - `project.config.json`：项目配置文件, 比如项目名称、`appid`等
    - `https://developers.weixin.qq.com/miniprogram/dev/devtools/projectconfig.html`
  - `sitemap.json`：小程序搜索相关的
    - `https://developers.weixin.qq.com/miniprogram/dev/framework/sitemap.html`
  - `app.json`：全局配置
  - `page.json`：页面配置





# 三. 全局配置文件`app.json`

---

- 全局配置比较多, 我们这里将几个比较重要的，完整的查看官方文档

- `https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/app.html`

- `pages`: 页面路径列表
  - 用于指定小程序由哪些页面组成，每一项都对应一个页面的路径(含文件名)信息
  - 小程序中所有的页面都是必须在`pages`中进行注册的
- `window`: 全局的默认窗口展示
  - 用户指定窗口如何展示, 其中还包含了很多其他的属性
- `tabBar`: 顶部`tab`栏的展示

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819183403266.png" alt="image-20220819183403266" style="zoom:67%;" />





# 四. 页面配置文件`page.json`

---

- 每一个小程序页面也可以使用`.json`文件来对本页面的窗口表现进行配置
  - 页面中配置项在当前页面会覆盖` app.json `的` window `中相同的配置项
  - `https://developers.weixin.qq.com/miniprogram/dev/reference/configuration/page.html`

![image-20220819183514034](C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819183514034.png)





# 五. 注册`App`实例的操作

---

## 1.注册小程序 – `App`函数

- 每个小程序都需要在` app.js `中调用` App `函数 注册小程序实例
  - 在注册时, 可以绑定对应的生命周期函数
  - 在生命周期函数中, 执行对应的代码
  - `https://developers.weixin.qq.com/miniprogram/dev/reference/api/App.html`
- 我们来思考：注册`App`时，我们一般会做什么呢？
  - 判断小程序的进入场景
  - 监听生命周期函数，在生命周期中执行对应的业务逻辑，比如在某个生命周期函数中进行登录操作或者请求网络数据
  - 因为`App()`实例只有一个，并且是全局共享的（单例对象），所以我们可以将一些共享数据放在这里

## 2.`App`函数的参数

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819202306213.png" alt="image-20220819202306213" style="zoom:67%;" />

## 3.作用一：判断打开场景

- 小程序的打开场景较多：
  - 常见的打开场景：群聊会话中打开、小程序列表中打开、微信扫一扫打开、另一个小程序打开
  - `https://developers.weixin.qq.com/miniprogram/dev/reference/scene-list.html`
- 如何确定场景? 
  - 在`onLaunch`和`onShow`生命周期回调函数中，会有`options`参数，其中有`scene`值

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819202416099.png" alt="image-20220819202416099" style="zoom:67%;" />

## 4.作用二：定义全局`App`的数据

- 作用二：可以在`APP.js`中定义全局`App`的数据

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819202512585.png" alt="image-20220819202512585" style="zoom:67%;" />

- 定义的数据可以在其他任何页面中访问：

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819202524456.png" alt="image-20220819202524456" style="zoom:67%;" />

## 5.作用三 – 生命周期函数

- 作用二：在生命周期函数中，完成应用程序启动后的初始化操作
  - 比如登录操作（这个后续会详细讲解）
  - 比如读取本地数据（类似于`token`，然后保存在全局方便使用）
  - 比如请求整个应用程序需要的数据

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819202642982.png" alt="image-20220819202642982" style="zoom:67%;" />





# 六. 注册`Page`实例的操作

---

## 1.注册页面 – `Page`函数

- 小程序中的每个页面, 都有一个对应的`js`文件, 其中调用`Page`函数注册页面实例
  - 在注册时, 可以绑定初始化数据、生命周期回调、事件处理函数等
  - `https://developers.weixin.qq.com/miniprogram/dev/reference/api/Page.html`
- 我们来思考：注册一个`Page`页面时，我们一般需要做什么呢？
  - 1.在生命周期函数中发送网络请求，从服务器获取数据
  - 2.初始化一些数据，以方便被`wxml`引用展示
  - 3.监听`wxml`中的事件，绑定对应的事件函数
  - 4.其他一些监听（比如页面滚动、下拉刷新、上拉加载更多等）

## 2.注册`Page`时做什么呢?

<img src="C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819202908285.png" alt="image-20220819202908285" style="zoom:67%;" />

## 3.`Page`页面的生命周期

- `onShow`函数是在渲染之前调用的

![image-20220819203021940](C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819203021940.png)

## 4.上拉和下拉的监听

- 监听页面的下拉刷新和上拉加载更多：

![image-20220819203203285](C:\Users\23634\AppData\Roaming\Typora\typora-user-images\image-20220819203203285.png)







