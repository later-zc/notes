# ä¸€. Streamçš„è¯»å†™æ“ä½œ 

---

## 1. è®¤è¯† Stream

- ä»€ä¹ˆæ˜¯ `Stream`ï¼ˆå°æºªã€å°æ²³ï¼Œåœ¨ç¼–ç¨‹ä¸­é€šå¸¸ç¿»è¯‘ä¸ºæµï¼‰å‘¢ï¼Ÿ
  - æˆ‘ä»¬çš„ç¬¬ä¸€ååº”åº”è¯¥æ˜¯æµæ°´ï¼Œæºæºä¸æ–­çš„æµåŠ¨
  - ç¨‹åºä¸­çš„æµä¹Ÿæ˜¯ç±»ä¼¼çš„å«ä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡å½“æˆ‘ä»¬ä»ä¸€ä¸ªæ–‡ä»¶ä¸­è¯»å–æ•°æ®æ—¶ï¼Œæ–‡ä»¶çš„äºŒè¿›åˆ¶ï¼ˆå­—èŠ‚ï¼‰æ•°æ®ä¼šæºæºä¸æ–­çš„è¢«è¯»å–åˆ°æˆ‘ä»¬ç¨‹åºä¸­
  - è€Œè¿™ä¸ªä¸€è¿ä¸²çš„å­—èŠ‚ï¼Œå°±æ˜¯æˆ‘ä»¬ç¨‹åºä¸­çš„æµ
- æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£æµï¼š
  - æ˜¯è¿ç»­å­—èŠ‚çš„ä¸€ç§è¡¨ç°å½¢å¼å’ŒæŠ½è±¡æ¦‚å¿µ
  - æµåº”è¯¥æ˜¯å¯è¯»çš„ï¼Œä¹Ÿæ˜¯å¯å†™çš„
- åœ¨ä¹‹å‰å­¦ä¹ æ–‡ä»¶çš„è¯»å†™æ—¶ï¼Œæˆ‘ä»¬**å¯ä»¥ç›´æ¥é€šè¿‡ `readFile` æˆ–è€… `writeFile` æ–¹å¼è¯»å†™æ–‡ä»¶ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦æµå‘¢ï¼Ÿ**
  - ç›´æ¥è¯»å†™æ–‡ä»¶çš„æ–¹å¼ï¼Œè™½ç„¶ç®€å•ï¼Œä½†æ˜¯æ— æ³•æ§åˆ¶ä¸€äº›ç»†èŠ‚çš„æ“ä½œ
  - æ¯”å¦‚ä»ä»€ä¹ˆä½ç½®å¼€å§‹è¯»ã€è¯»åˆ°ä»€ä¹ˆä½ç½®ã€ä¸€æ¬¡æ€§è¯»å–å¤šå°‘ä¸ªå­—èŠ‚
  - è¯»åˆ°æŸä¸ªä½ç½®åï¼Œæš‚åœè¯»å–ï¼ŒæŸä¸ªæ—¶åˆ»æ¢å¤ç»§ç»­è¯»å–ç­‰ç­‰
  - æˆ–è€…è¿™ä¸ªæ–‡ä»¶éå¸¸å¤§ï¼Œæ¯”å¦‚ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ï¼Œä¸€æ¬¡æ€§å…¨éƒ¨è¯»å–å¹¶ä¸åˆé€‚

## 2. æ–‡ä»¶è¯»å†™çš„ Stream

- äº‹å®ä¸Š `Node` ä¸­å¾ˆå¤šå¯¹è±¡æ˜¯åŸºäºæµå®ç°çš„ï¼š
  - `http` æ¨¡å—çš„ `Request` å’Œ `Response` å¯¹è±¡
- å®˜æ–¹æ–‡æ¡£ï¼šå¦å¤–**æ‰€æœ‰çš„æµéƒ½æ˜¯ `EventEmitter` çš„å®ä¾‹**
- é‚£ä¹ˆåœ¨ `Node` ä¸­éƒ½æœ‰å“ªäº›æµå‘¢ï¼Ÿ
- **`Node.js` ä¸­æœ‰å››ç§åŸºæœ¬æµç±»å‹ï¼ˆå¯å†™æµã€å¯è¯»æµã€åŒå‘æµã€å¯å˜æµï¼‰**ï¼š
  - `Writable`ï¼šå¯ä»¥å‘å…¶å†™å…¥æ•°æ®çš„æµï¼ˆä¾‹å¦‚ `fs.createWriteStream()`ï¼‰
  - `Readable`ï¼šå¯ä»¥ä»ä¸­è¯»å–æ•°æ®çš„æµï¼ˆä¾‹å¦‚ `fs.createReadStream()`ï¼‰
  - `Duplex`ï¼šåŒæ—¶ä¸º `Readable` å’Œ `Writable`ï¼ˆä¾‹å¦‚ `net.Socket`ï¼‰
  - `Transform`ï¼š`Duplex`å¯ä»¥åœ¨å†™å…¥å’Œè¯»å–æ•°æ®æ—¶ä¿®æ”¹æˆ–è½¬æ¢æ•°æ®çš„æµï¼ˆä¾‹å¦‚ `zlib.createDeflate()`ï¼‰
- è¿™é‡Œæˆ‘ä»¬é€šè¿‡ `fs` çš„æ“ä½œï¼Œè®²è§£ä¸€ä¸‹ `Writable`ã€`Readable`ï¼Œå¦å¤–ä¸¤ä¸ªå¤§å®¶å¯ä»¥è‡ªè¡Œå­¦ä¹ ä¸€ä¸‹

## 3. Readable

- ä¹‹å‰æˆ‘ä»¬è¯»å–ä¸€ä¸ªæ–‡ä»¶çš„ä¿¡æ¯ï¼š

  ```js
  const fs = require('fs')
  
  // 1.ä¸€æ¬¡æ€§è¯»å–
  // ç¼ºç‚¹ä¸€ï¼šæ²¡æœ‰åŠæ³•ç²¾å‡†æ§åˆ¶ä»ä½•å¤„å¼€å§‹è¯»å–ï¼ŒåŠè¯»å–åˆ°ä½•å¤„æˆªæ­¢
  // ç¼ºç‚¹äºŒï¼šä¸èƒ½è¯»å–åˆ°æŸä¸ªä½ç½®æ—¶ï¼Œæš‚åœè¯»å–ï¼Œæ¢å¤è¯»å–
  // ç¼ºç‚¹ä¸‰ï¼šæ–‡ä»¶éå¸¸å¤§çš„æ—¶å€™ï¼Œæ— æ³•å¤šæ¬¡è¯»å–
  fs.readFile('./a.txt', (err, data) => {
    console.log('data: ', data)
  })
  ```

- è¿™ç§æ–¹å¼æ˜¯ä¸€æ¬¡æ€§å°†ä¸€ä¸ªæ–‡ä»¶ä¸­æ‰€æœ‰çš„å†…å®¹éƒ½è¯»å–åˆ°ç¨‹åºï¼ˆå†…å­˜ï¼‰ä¸­ï¼Œä½†æ˜¯è¿™ç§è¯»å–æ–¹å¼å°±ä¼šå‡ºç°æˆ‘ä»¬ä¹‹å‰æåˆ°çš„å¾ˆå¤šé—®é¢˜ï¼š
  - æ–‡ä»¶è¿‡å¤§ã€è¯»å–çš„ä½ç½®ã€ç»“æŸçš„ä½ç½®ã€ä¸€æ¬¡è¯»å–çš„å¤§å°
- è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `createReadStream`ï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå‚æ•°ï¼Œæ›´å¤šå‚æ•°å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š
  - `start`ï¼šæ–‡ä»¶è¯»å–å¼€å§‹çš„ä½ç½®ï¼ˆåŒ…æ‹¬è¯¥ç´¢å¼•ä½ç½®ï¼‰
  - `end`ï¼šæ–‡ä»¶è¯»å–ç»“æŸçš„ä½ç½®ï¼ˆåŒ…æ‹¬è¯¥ç´¢å¼•ä½ç½®ï¼‰
  - `highWaterMark`ï¼šä¸€æ¬¡æ€§è¯»å–å­—èŠ‚çš„é•¿åº¦ï¼Œé»˜è®¤æ˜¯`64kb`

## 4. Readable çš„ä½¿ç”¨

- åˆ›å»ºæ–‡ä»¶çš„ `Readable`

- æˆ‘ä»¬å¦‚ä½•è·å–åˆ°æ•°æ®å‘¢ï¼Ÿå¯ä»¥é€šè¿‡ç›‘å¬ `data` äº‹ä»¶ï¼Œè·å–è¯»å–åˆ°çš„æ•°æ®

- ä¹Ÿå¯ä»¥åšä¸€äº›å…¶ä»–çš„æ“ä½œï¼šç›‘å¬å…¶ä»–äº‹ä»¶ã€æš‚åœæˆ–è€…æ¢å¤

  ```js
  // 2.é€šè¿‡æµè¯»å–æ–‡ä»¶
  // 2.1 åˆ›å»ºä¸€ä¸ªå¯è¯»æµ
  const readStream = fs.createReadStream('./a.txt', {
    start: 2, // ä»€ä¹ˆä½ç½®å¼€å§‹è¯»å–
    end: 10, // ç»“æŸè¯»å–ä½ç½®
    highWaterMark: 3, // ä¸€æ¬¡æ€§è¯»å–å­—èŠ‚çš„é•¿åº¦
  })
  
  // 2.2 ç›‘å¬è¯»å–åˆ°çš„æ•°æ®
  readStream.on('data', (data) => {
    console.log('data.toString(): ', data.toString())
    readStream.pause() // æš‚åœè¯»å–
    setTimeout(() => {
      readStream.resume() // æ¢å¤è¯»å–
    }, 2000)
  })
  
  // 3.è¡¥å……å…¶ä»–çš„äº‹ä»¶ç›‘å¬
  readStream.on('open', (fd) => {
    console.log('ç›‘å¬åˆ°: é€šè¿‡æµå°†æ–‡ä»¶æ‰“å¼€~, fd: ', fd)
  })
  
  readStream.on('end', () => {
    console.log('ç›‘å¬åˆ°: å·²ç»è¯»å–åˆ°endä½ç½®~')
  })
  
  readStream.on('close', () => {
    console.log('ç›‘å¬åˆ°ï¼šæ–‡ä»¶è¯»å–ç»“æŸå¹¶è¢«å…³é—­')
  })
  ```

## 5. Writable

- ä¹‹å‰æˆ‘ä»¬å†™å…¥ä¸€ä¸ªæ–‡ä»¶çš„æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š

  ```js
  fs.writeFile(
    './a.txt',
    'hello world',
    {
      flag: 'a+',
    },
    (err, data) => {
      console.log('data: ', data)
    }
  )
  ```

- è¿™ç§æ–¹å¼ç›¸å½“äºä¸€æ¬¡æ€§å°†æ‰€æœ‰çš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿæœ‰å¾ˆå¤šé—®é¢˜ï¼š

  - æ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä¸€ç‚¹ç‚¹å†™å…¥å†…å®¹ï¼Œç²¾ç¡®æ¯æ¬¡å†™å…¥çš„ä½ç½®ç­‰

- è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `createWriteStream`ï¼Œæˆ‘ä»¬æ¥çœ‹å‡ ä¸ªå‚æ•°ï¼Œæ›´å¤šå‚æ•°å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š

  - `flags`ï¼šé»˜è®¤æ˜¯ `w`ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æ˜¯è¿½åŠ å†™å…¥ï¼Œå¯ä»¥ä½¿ç”¨ `a` æˆ–è€… `a+`
  - `start`ï¼šå†™å…¥çš„ä½ç½®

## 6. Writable çš„ä½¿ç”¨

- æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡ç®€å•çš„å†™å…¥

  ```js
  // åˆ›å»ºä¸€ä¸ªå†™å…¥æµ
  const writeStream = fs.createWriteStream('./a.txt', {
    start: 1,
  })
  
  writeStream.write('666~')
  writeStream.write('666~', (err) => {
    console.log('å†™å…¥å®Œæˆ~: ', err)
  })
  ```

- ä½ å¯ä»¥ç›‘å¬ `open` äº‹ä»¶ï¼š

  ```js
  writeStream.on('open', () => {
    console.log('æ–‡ä»¶è¢«æ‰“å¼€~')
  })
  ```

## 7. close çš„ç›‘å¬

- æˆ‘ä»¬ä¼šå‘ç°ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½ç›‘å¬åˆ° `close` äº‹ä»¶ï¼š

  - è¿™æ˜¯å› ä¸ºå†™å…¥æµåœ¨æ‰“å¼€åæ˜¯ä¸ä¼šè‡ªåŠ¨å…³é—­çš„
  - æˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨å…³é—­ï¼Œæ¥å‘Šè¯‰ `Node` å·²ç»å†™å…¥ç»“æŸäº†
  - å¹¶ä¸”ä¼šå‘å‡ºä¸€ä¸ª `finish` äº‹ä»¶çš„

- å¦å¤–ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„æ–¹æ³•æ˜¯ `end`ï¼š**`end`æ–¹æ³•ç›¸å½“äºåšäº†ä¸¤æ­¥æ“ä½œï¼š  `write` ä¼ å…¥çš„æ•°æ®å’Œè°ƒç”¨ `close` æ–¹æ³•**

  ```js
  // åˆ›å»ºä¸€ä¸ªå†™å…¥æµ
  const writeStream = fs.createWriteStream('./a.txt', {
    start: 1,
  })
  
  writeStream.on('open', () => {
    console.log('æ–‡ä»¶è¢«æ‰“å¼€~')
  })
  
  writeStream.write('666~')
  writeStream.write('666~', (err) => {
    console.log('å†™å…¥å®Œæˆ~: ', err)
  })
  
  writeStream.on('finish', () => {
    console.log('å†™å…¥å®Œæˆäº†~')
  })
  
  writeStream.on('close', () => {
    console.log('æ–‡ä»¶è¢«å…³é—­~')
  })
  
  // 3.å†™å…¥å®Œæˆæ—¶, éœ€æ‰‹åŠ¨è°ƒç”¨closeæ–¹æ³•
  // writeStream.close()
  
  // 4. endæ–¹æ³•: å°†æœ€åçš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œå¹¶å…³é—­æ–‡ä»¶
  writeStream.end('å“ˆå“ˆå“ˆ')
  ```

## 8. æ–‡ä»¶çš„æ‹·è´æµæ“ä½œ - pipe æ–¹æ³•

- æ­£å¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬**å¯ä»¥å°†è¯»å–åˆ°çš„ è¾“å…¥æµï¼Œæ‰‹åŠ¨çš„æ”¾åˆ° è¾“å‡ºæµä¸­è¿›è¡Œå†™å…¥**ï¼š

  ```js
  const fs = require('fs')
  
  // 1.æ–¹å¼ä¸€ï¼šä¸€æ¬¡æ€§è¯»å–å’Œå†™å…¥æ–‡ä»¶
  fs.readFile('./b.txt', (err, data) => {
    fs.writeFile('./foo_copy01.txt', data, () => {
      console.log('å†™å…¥æ–‡ä»¶å®Œæˆ')
    })
  })
  
  // 2.æ–¹å¼äºŒï¼šåˆ›å»ºå¯è¯»æµå’Œå¯å†™æµ
  const readStream = fs.createReadStream('./b.txt')
  const writeStream = fs.createWriteStream('./foo_copy02.txt')
  
  readStream.on('data', (data) => {
    writeStream.write(data)
  })
  
  readStream.on('end', () => {
    writeStream.close()
  })
  ```

- æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ `pipe`ï¼ˆç®¡é“ï¼‰ æ¥å®Œæˆè¿™æ ·çš„æ“ä½œï¼š

  ```js
  // 3.åœ¨å¯è¯»æµå’Œå¯å†™æµä¹‹é—´å»ºç«‹ä¸€ä¸ªç®¡é“
  // å¯è¯»æµä¸­è¯»å–åˆ°çš„æ•°æ®ç›´æ¥æ”¾åˆ°å¯å†™æµä¸­
  const readStream = fs.createReadStream('./b.txt')
  const writeStream = fs.createWriteStream('./foo_copy03.txt')
  readStream.pipe(writeStream)
  ```


## 9. å¯å†™æµçš„startå±æ€§ï¼Œåœ¨windowä¸Šçš„å…¼å®¹æ€§é—®é¢˜

```js
const fs = require('fs')

const writeStream = fs.createWriteStream('./c.txt', {
  // windowså…¼å®¹æ€§é—®é¢˜ï¼šflagsä¸ºa+æ—¶ï¼Œæ— æ³•åœ¨startä½ç½®å¤„å†™å…¥ï¼Œè€Œæ˜¯åœ¨æœ«å°¾å†™å…¥
  // macæ— æ­¤é—®é¢˜ï¼Œwindowæœ‰æ­¤é—®é¢˜
  // flags: 'a+',
  // è§£å†³æ–¹å¼ï¼šä½¿ç”¨'r+'ï¼Œæ–°æ•°æ®ä¼šè¦†ç›–å¯¹åº”ä½ç½®ä¸Šçš„åŸæœ‰æ•°æ®
  flags: 'r+',
  start: 1,
})

writeStream.write('---')
```





# äºŒ. httpæ¨¡å—webæœåŠ¡

---

## 1. Web æœåŠ¡å™¨

- ä»€ä¹ˆæ˜¯ `Web` æœåŠ¡å™¨ï¼Ÿ

  - å½“åº”ç”¨ç¨‹åºï¼ˆå®¢æˆ·ç«¯ï¼‰éœ€è¦æŸä¸€ä¸ªèµ„æºæ—¶ï¼Œå¯ä»¥å‘ä¸€å°æœåŠ¡å™¨ï¼Œé€šè¿‡ `Http` è¯·æ±‚è·å–åˆ°è¿™ä¸ªèµ„æº
  - æä¾›èµ„æºçš„è¿™ä¸ªæœåŠ¡å™¨ï¼Œå°±æ˜¯ä¸€ä¸ª `Web` æœåŠ¡å™¨

  <img src="assets/image-20230204104418472.png" alt="image-20230204104418472" style="zoom:80%;" />

- ç›®å‰æœ‰å¾ˆå¤šå¼€æºçš„ `Web` æœåŠ¡å™¨ï¼š`Nginx`ã€`Apache`ï¼ˆé™æ€ï¼‰ã€`Apache Tomcat`ï¼ˆé™æ€ã€åŠ¨æ€ï¼‰ã€`Node.js`

## 2. http æ¨¡å—

- åœ¨ `Node` ä¸­ï¼Œ**æä¾› `web` æœåŠ¡å™¨çš„èµ„æºè¿”å›ç»™æµè§ˆå™¨**ï¼Œä¸»è¦æ˜¯é€šè¿‡ `http` æ¨¡å—

- æˆ‘ä»¬å…ˆç®€å•å¯¹å®ƒåšä¸€ä¸ªä½¿ç”¨ï¼š

  ```js
  const http = require('http')
  const HTTP_HOST = 8000
  // åˆ›å»ºä¸€ä¸ªhttpå¯¹åº”çš„æœåŠ¡å™¨
  const server = http.createServer((request, response) => {
    // requestå¯¹è±¡ä¸­åŒ…å«æœ¬æ¬¡å®¢æˆ·ç«¯è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆrequestæœ¬è´¨æ˜¯ä¸€ä¸ªå¯è¯»æµï¼‰
    // è¯·æ±‚çš„url
    // è¯·æ±‚çš„method
    // è¯·æ±‚çš„headers
    // è¯·æ±‚æºå¸¦çš„æ•°æ®
    // ...
    // responseå¯¹è±¡ç”¨äºç»™å®¢æˆ·ç«¯è¿”å›ç»“æœçš„ï¼ˆresponseæœ¬è´¨æ˜¯ä¸€ä¸ªå¯å†™æµï¼‰
    response.end('hello world')
  })
  
  // å¼€å¯å¯¹åº”çš„æœåŠ¡å™¨ï¼Œå¹¶å‘ŠçŸ¥éœ€ç›‘å¬çš„ç«¯å£
  // 1024åŠä»¥ä¸‹çš„ç«¯å£ï¼Œä¸€èˆ¬æ˜¯ç»™é‚£äº›ç‰¹æ®ŠæœåŠ¡æ¥ç›‘å¬çš„
  // ç›‘å¬ç«¯å£æ—¶ï¼Œä¸€èˆ¬ç›‘å¬1024ä»¥ä¸Šçš„ç«¯å£~65536ä»¥ä¸‹çš„ç«¯å£
  // 1024~65536ä¹‹é—´çš„ç«¯å£
  // ä¸ºä»€ä¹ˆåœ¨65536å‘¢ï¼Ÿå› ä¸ºåœ¨å¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸­ï¼Œç«¯å£åœ¨ä¿å­˜çš„æ—¶å€™æ˜¯ç”¨äº†ä¸¤ä¸ªå­—èŠ‚ï¼Œä¸¤ä¸ªå­—èŠ‚èƒ½è¡¨ç¤ºæœ€å¤§çš„æ•°å€¼åœ¨65535
  // 2ä¸ªbyte => 256*256  65535
  server.listen(HTTP_HOST, () => {
    console.log(`æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ç«¯å£: ${HTTP_HOST}`)
  })
  ```

> è¡¥å……ï¼š
>
> - **å­—èŠ‚**ï¼ˆè‹±è¯­ï¼š`byte`ï¼‰ï¼Œé€šå¸¸ç”¨ä½œç”µè„‘åŠæ‰‹æœºç­‰ ä¿¡æ¯è®¡é‡å•ä½ï¼Œä¸åˆ†æ•°æ®ç±»å‹ã€‚æ˜¯é€šä¿¡å’Œæ•°æ®å­˜å‚¨çš„æ¦‚å¿µã€‚**ä¸€ä¸ªå­—èŠ‚ = å…«ä¸ªæ¯”ç‰¹**
> - **æ¯”ç‰¹**ï¼ˆè‹±è¯­ï¼š`bit`ï¼Œäº¦ç§°äºŒè¿›åˆ¶ä½ï¼‰**æŒ‡äºŒè¿›åˆ¶çš„ä¸€ä½**ï¼Œæ˜¯ä¿¡æ¯çš„æœ€å°å•ä½
> - äºŒè¿›åˆ¶åªèƒ½è¡¨ç¤º `0` å’Œ `1`ï¼Œ**ä¸€ä¸ªå­—èŠ‚ = å…«ä½äºŒè¿›åˆ¶**
> - **å…«ä½äºŒè¿›åˆ¶èƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼ï¼š`1111 1111`ï¼Œè½¬ä¸ºåè¿›åˆ¶å³ `255`**

## 3. åˆ›å»ºæœåŠ¡å™¨

- åˆ›å»ºæœåŠ¡å™¨å¯¹è±¡ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ `createServer` æ¥å®Œæˆçš„

  - `http.createServer` ä¼šè¿”å›æœåŠ¡å™¨çš„å¯¹è±¡

  - åº•å±‚å…¶å®ä½¿ç”¨ç›´æ¥ `new Server` å¯¹è±¡

    ```js
    function createServer(opts, requestListener) {
      return new Server(opts, requestListener)
    }
    ```

- é‚£ä¹ˆï¼Œå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ¥åˆ›å»ºè¿™ä¸ªå¯¹è±¡ï¼š

  ```js
  const http = require('http')
  const HTTP_HOST_01 = 2001
  const HTTP_HOST_02 = 2002
  
  // åˆ›å»ºç¬¬1ä¸ªæœåŠ¡å™¨
  const serv1 = http.createServer((req, res) => {
    res.end(`${HTTP_HOST_01}ç«¯å£æœåŠ¡å™¨è¿”å›çš„ç»“æœ`)
  })
  serv1.listen(HTTP_HOST_01, () => {
    console.log(`æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ç«¯å£: ${HTTP_HOST_01}`)
  })
  
  // åˆ›å»ºç¬¬2ä¸ªæœåŠ¡å™¨
  const serv2 = new http.Server((req, res) => {
    res.end(`${HTTP_HOST_02}ç«¯å£æœåŠ¡å™¨è¿”å›çš„ç»“æœ`)
  })
  serv2.listen(HTTP_HOST_02, () => {
    console.log(`æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ç«¯å£: ${HTTP_HOST_02}`)
  })
  ```

- ä¸Šé¢æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œåˆ›å»º `Server` æ—¶ä¼šä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå›è°ƒå‡½æ•°åœ¨è¢«è°ƒç”¨æ—¶ä¼šä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼š

  - `req`ï¼š`request` è¯·æ±‚å¯¹è±¡ï¼ŒåŒ…å«è¯·æ±‚ç›¸å…³çš„ä¿¡æ¯
  - `res`ï¼š`response` å“åº”å¯¹è±¡ï¼ŒåŒ…å«æˆ‘ä»¬è¦å‘é€ç»™å®¢æˆ·ç«¯çš„ä¿¡æ¯

## 4. ç›‘å¬ä¸»æœºå’Œç«¯å£å·

- `Server` é€šè¿‡ `listen` æ–¹æ³•æ¥å¼€å¯æœåŠ¡å™¨ï¼Œå¹¶ä¸”åœ¨æŸä¸€ä¸ªä¸»æœºå’Œç«¯å£ä¸Šç›‘å¬ç½‘ç»œè¯·æ±‚ï¼š
  - ä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬é€šè¿‡ `ip:port` çš„æ–¹å¼å‘é€åˆ°æˆ‘ä»¬ç›‘å¬çš„ `Web` æœåŠ¡å™¨ä¸Šæ—¶
  - æˆ‘ä»¬å°±å¯ä»¥å¯¹å…¶è¿›è¡Œç›¸å…³çš„å¤„ç†
- `listen` å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼š
- ç«¯å£ `port`ï¼šå¯ä»¥ä¸ä¼ ï¼Œç³»ç»Ÿä¼šé»˜è®¤åˆ†é…ç«¯å£ï¼Œåç»­é¡¹ç›®ä¸­æˆ‘ä»¬ä¼šå†™å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­
- ä¸»æœº `hostname`ï¼šé€šå¸¸å¯ä»¥ä¼ å…¥ `localhost`ã€`ip` åœ°å€ `127.0.0.1`ã€æˆ–è€… `ip` åœ°å€ `0.0.0.0`ï¼Œé»˜è®¤æ˜¯ `0.0.0.0`
  - `localhost`ï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸŸåï¼Œé€šå¸¸æƒ…å†µä¸‹ä¼šè¢«è§£ææˆ `127.0.0.1`
  - `127.0.0.1`ï¼šå›ç¯åœ°å€ï¼ˆ`Loop Back Address`ï¼‰ï¼Œè¡¨è¾¾çš„æ„æ€å…¶å®æ˜¯æˆ‘ä»¬ä¸»æœºè‡ªå·±å‘å‡ºå»çš„åŒ…ï¼Œç›´æ¥è¢«è‡ªå·±æ¥æ”¶
    - æ­£å¸¸çš„æ•°æ®åº“åŒ…ç»å¸¸ åº”ç”¨å±‚ - ä¼ è¾“å±‚ - ç½‘ç»œå±‚ - æ•°æ®é“¾è·¯å±‚ - ç‰©ç†å±‚ 
    - è€Œå›ç¯åœ°å€ï¼Œæ˜¯åœ¨ç½‘ç»œå±‚ç›´æ¥å°±è¢«è·å–åˆ°äº†ï¼Œæ˜¯ä¸ä¼šç»å¸¸æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚çš„
    - æ¯”å¦‚æˆ‘ä»¬ç›‘å¬ `127.0.0.1` æ—¶ï¼Œåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹çš„å…¶ä»–ä¸»æœºä¸­ï¼Œé€šè¿‡ `ip` åœ°å€æ˜¯ä¸èƒ½è®¿é—®çš„
  - `0.0.0.0`ï¼š
    - ç›‘å¬ `IPV4` ä¸Šæ‰€æœ‰çš„åœ°å€ï¼Œå†æ ¹æ®ç«¯å£æ‰¾åˆ°ä¸åŒçš„åº”ç”¨ç¨‹åº
    - æ¯”å¦‚æˆ‘ä»¬ç›‘å¬ `0.0.0.0` æ—¶ï¼Œåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹çš„å…¶ä»–ä¸»æœºä¸­ï¼Œé€šè¿‡ `ip` åœ°å€æ˜¯å¯ä»¥è®¿é—®çš„
- å›è°ƒå‡½æ•°`cb`ï¼šæœåŠ¡å™¨å¯åŠ¨æˆåŠŸæ—¶çš„å›è°ƒå‡½æ•°

## 5. nodemon æ–‡ä»¶ä¿®æ”¹è‡ªåŠ¨é‡å¯æœåŠ¡å™¨

- å¯¹äºæ¯æ¬¡ä¿®æ”¹ä»£ç éœ€è¦æ‰‹åŠ¨é‡å¯æœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©ä¸€ä¸ªåº“ `node ` `mon` (`monitor`ä¾¦æµ‹å™¨)æ¥å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨é‡å¯æœåŠ¡å™¨

  ```bash
  npm i nodemon -g
  ```

- å…¨å±€å®‰è£…ï¼Œå› ä¸ºè¿™ä¸ªå·¥å…·æˆ‘ä»¬åœ¨å…¶ä»–é¡¹ç›®ä¸­ä¹Ÿå¯èƒ½ä¼šä½¿ç”¨åˆ°è¿™ä¸ªå·¥å…·

  ```bash
  // ä½¿ç”¨
  nodemon xxx.js
  ```

- ä¹‹åæ£€æµ‹åˆ° `xxx.js` æ–‡ä»¶ä¿®æ”¹ï¼Œå°±ä¼šè‡ªåŠ¨é‡å¯æœåŠ¡å™¨

## 6. æµè§ˆå™¨ä¸­è¾“å…¥æŸä¸ªåœ°å€è®¿é—®æ—¶çš„ç‰¹æ€§

- å½“åœ¨æµè§ˆå™¨ä¸­è¾“å…¥æŸä¸ªåœ°å€è®¿é—®æ—¶ï¼Œä¼šé»˜è®¤è®¿é—®è¯¥åœ°å€ä¸‹çš„ `favicon.ico` å›¾æ ‡ï¼Œæ‰€ä»¥ä¹Ÿä¼šå¯¹æœåŠ¡å™¨è¿›è¡Œä¸€æ¬¡è®¿é—®ï¼Œå› æ­¤ä¸‹é¢ä»£ç ä¸­çš„ `æœåŠ¡å™¨è¢«è®¿é—®~` ä¼šè¢«æ‰“å°ä¸¤æ¬¡

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    console.log('æœåŠ¡å™¨è¢«è®¿é—®~')
    res.end('hello world')
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~')
  })
  ```

- æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å€ŸåŠ© `postman` å·¥å…·æ¥å‘èµ·è¯·æ±‚





# ä¸‰. requestè¯·æ±‚å¯¹è±¡ 

---

## 1. request å¯¹è±¡

- åœ¨å‘æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä¼šæºå¸¦å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š

  - æœ¬æ¬¡è¯·æ±‚çš„ `URL`ï¼ŒæœåŠ¡å™¨éœ€è¦æ ¹æ®ä¸åŒçš„ `URL` è¿›è¡Œä¸åŒçš„å¤„ç†
  - æœ¬æ¬¡è¯·æ±‚çš„è¯·æ±‚æ–¹å¼ï¼Œæ¯”å¦‚ `GET`ã€`POST` è¯·æ±‚ä¼ å…¥çš„å‚æ•°å’Œå¤„ç†çš„æ–¹å¼æ˜¯ä¸åŒçš„
  - æœ¬æ¬¡è¯·æ±‚çš„ `headers` ä¸­ä¹Ÿä¼šæºå¸¦ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯ä¿¡æ¯ã€æ¥å—æ•°æ®çš„æ ¼å¼ã€æ”¯æŒçš„ç¼–ç æ ¼å¼ç­‰
  - ç­‰ç­‰...

- è¿™äº›ä¿¡æ¯ï¼Œ`Node` ä¼šå¸®åŠ©æˆ‘ä»¬å°è£…åˆ°ä¸€ä¸ª `request` çš„å¯¹è±¡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ¥å¤„ç†è¿™ä¸ª `request` å¯¹è±¡ï¼š

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    // requestå¯¹è±¡åŒ…å«å“ªäº›ä¿¡æ¯
    // 1.url
    console.log('req.url: ', req.url)
    // 2.methodè¯·æ±‚æ–¹å¼
    console.log('req.method: ', req.method)
    // 3.headers
    console.log('req.headers: ', req.headers)
    res.end('hello world')
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~')
  })
  ```

## 2. URL çš„å¤„ç†

- å®¢æˆ·ç«¯åœ¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šè¯·æ±‚ä¸åŒçš„æ•°æ®ï¼Œé‚£ä¹ˆä¼šä¼ å…¥ä¸åŒçš„è¯·æ±‚åœ°å€ï¼š

  - æ¯”å¦‚ http://localhost:8000/login
  - æ¯”å¦‚ http://localhost:8000/products

- æœåŠ¡å™¨ç«¯éœ€è¦æ ¹æ®ä¸åŒçš„è¯·æ±‚åœ°å€ï¼Œä½œå‡ºä¸åŒçš„å“åº”ï¼š

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    const url = req.url
    switch (url) {
      case '/login':
        res.end('ç™»å½•æˆåŠŸ~')
        break
      case '/products':
        res.end('å•†å“åˆ—è¡¨~')
        break
      case '/lyric':
        res.end('å¤©ç©ºå¥½æƒ³ä¸‹é›¨ï¼Œæˆ‘å¥½æƒ³ä½ä½ éš”å£ï¼')
        break
    }
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~')
  })
  ```

## 3. URL çš„è§£æ

- é‚£ä¹ˆå¦‚æœç”¨æˆ·å‘é€çš„åœ°å€ä¸­è¿˜æºå¸¦ä¸€äº›é¢å¤–çš„å‚æ•°å‘¢ï¼Ÿ

  - http://localhost:8000/home?a=1&b=2
  - è¿™ä¸ªæ—¶å€™ï¼Œ`url` çš„å€¼æ˜¯ `/home?a=1&b=2`

- æˆ‘ä»¬å¦‚ä½•å¯¹å®ƒè¿›è¡Œè§£æå‘¢ï¼Ÿä½¿ç”¨å†…ç½®æ¨¡å— `url`ï¼š

  ```js
  const url = require('url')
  // ...
  const urlInfo = url.parse(req.url)
  // ...
  ```

- ä½†æ˜¯ `query` ä¿¡æ¯å¦‚ä½•å¯ä»¥è·å–å‘¢ï¼Ÿå¯ä»¥å€ŸåŠ©å†…ç½®æ¨¡å— `querystring`ï¼ˆå®˜æ–¹å·²å¼ƒç”¨ï¼Œæ¨èä½¿ç”¨ `URLSearchParams`ï¼‰

  ```js
  const http = require('http')
  const url = require('url')
  const qs = require('querystring')
  
  const server = http.createServer((req, res) => {
    // 1.å‚æ•°ä¸€ï¼šqueryç±»å‹å‚æ•°
    // /home?a=1&b=2
    console.log('req.url: ', req.url) // /home?a=1&b=2
  
    const urlInfo = url.parse(req.url)
    console.log('urlInfo: ', urlInfo)
    
  	// urlInfo.query: a=1&b=2
    const queryInfo = qs.parse(urlInfo.query)
    console.log('queryInfo: ', queryInfo) // queryInfo: {a: '1', b: '2'}
  
    res.end('hello world~ ğŸš€ğŸš€ğŸš€')
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')
  })
  ```

## 4. method çš„å¤„ç†

- åœ¨ `Restful` è§„èŒƒï¼ˆè®¾è®¡é£æ ¼ï¼‰ä¸­ï¼Œæˆ‘ä»¬å¯¹äºæ•°æ®çš„å¢åˆ æ”¹æŸ¥åº”è¯¥é€šè¿‡ä¸åŒçš„è¯·æ±‚æ–¹å¼ï¼š

  - `GET`ï¼šæŸ¥è¯¢æ•°æ®
  - `POST`ï¼šæ–°å»ºæ•°æ®
  - `PATCH`ï¼šæ›´æ–°æ•°æ®
  - `DELETE`ï¼šåˆ é™¤æ•°æ®

- æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ¤æ–­ä¸åŒçš„è¯·æ±‚æ–¹å¼è¿›è¡Œä¸åŒçš„å¤„ç†

  - æ¯”å¦‚åˆ›å»ºä¸€ä¸ªç”¨æˆ·
  - è¯·æ±‚æ¥å£ä¸º `/users`
  - è¯·æ±‚æ–¹å¼ä¸º `POST` è¯·æ±‚
  - æºå¸¦æ•°æ® `username` å’Œ `password`

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    const { url, method } = req
    switch (url) {
      case '/login':
        method === 'POST'
        	? res.end('ç™»å½•æˆåŠŸ~')
        	: res.end('ä¸æ”¯æŒçš„è¯·æ±‚æ–¹å¼')
        break
      case '/products':
        res.end('å•†å“åˆ—è¡¨~')
        break
      case '/lyric':
        res.end('å¤©ç©ºå¥½æƒ³ä¸‹é›¨ï¼Œæˆ‘å¥½æƒ³ä½ä½ éš”å£ï¼')
        break
    }
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~')
  })
  ```

## 5. åˆ›å»ºç”¨æˆ·æ¥å£

- åœ¨æˆ‘ä»¬ç¨‹åºä¸­å¦‚ä½•è¿›è¡Œåˆ¤æ–­ä»¥åŠè·å–å¯¹åº”çš„æ•°æ®å‘¢ï¼Ÿ

  - è¿™é‡Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­æ¥å£æ˜¯ `/users`ï¼Œå¹¶ä¸”è¯·æ±‚æ–¹å¼æ˜¯ `POST` æ–¹æ³•å»è·å–ä¼ å…¥çš„æ•°æ®
  - è·å–è¿™ç§ `body` æºå¸¦çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç›‘å¬ `req` çš„ `data` äº‹ä»¶æ¥è·å–

- å°† `JSON` å­—ç¬¦ä¸²æ ¼å¼è½¬æˆå¯¹è±¡ç±»å‹ï¼Œé€šè¿‡ `JSON.parse` æ–¹æ³•å³å¯

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    // è·å–å‚æ•°ï¼šbodyå‚æ•°
    // è®¾ç½®å¯è¯»æµä¸­çš„ç¼–ç æ ¼å¼ï¼Œè·å–åˆ°å¯è¯»æµä¸­çš„æ•°æ®æ—¶ä¼šæ ¹æ®ç¼–ç æ ¼å¼è¿›è¡Œè½¬æ¢
    req.setEncoding('utf-8')
  
    // requestå¯¹è±¡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯è¯»æµï¼Œè€Œè¿™äº›æµéƒ½ç»§æ‰¿è‡ªEventEmitterå¯¹è±¡ï¼Œè‡ªç„¶ä¹Ÿå°±æœ‰onè¿™äº›æ–¹æ³•å»ç›‘å¬dataè¿™äº›äº‹ä»¶
    let isLogin = null
    req.on('data', (data) => {
      console.log('data: ', data)
      const loginInfo = JSON.parse(data)
      if (loginInfo.name === 'later-zc' && loginInfo.password === 123) {
        isLogin = true
      } else {
        isLogin = false
      }
    })
  
    req.on('end', () => {
      if (isLogin) {
        res.end('ç™»å½•æˆåŠŸï¼Œæ¬¢è¿å›æ¥~ ğŸš€ğŸš€ğŸš€')
      } else {
        res.end('è´¦æˆ·æˆ–å¯†ç é”™è¯¯')
      }
    })
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')
  })
  ```


## 6. HTTP Request Header

- åœ¨ `request` å¯¹è±¡çš„ `header` ä¸­ä¹ŸåŒ…å«å¾ˆå¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯ä¼šé»˜è®¤ä¼ é€’è¿‡æ¥ä¸€äº›ä¿¡æ¯ï¼š<img src="assets/image-20230205103129592.png" alt="image-20230205103129592" style="zoom:80%;" />

- **`content-type` æ˜¯è¿™æ¬¡è¯·æ±‚æºå¸¦çš„æ•°æ®ç±»å‹**ï¼š
  - `application/x-www-form-urlencoded`ï¼šè¡¨ç¤ºæ•°æ®è¢«ç¼–ç æˆä»¥ `&` åˆ†éš”çš„é”® - å€¼å¯¹ï¼ŒåŒæ—¶ä»¥ `=` åˆ†éš”é”®å’Œå€¼
  - `application/json`ï¼šè¡¨ç¤ºæ˜¯ä¸€ä¸ª`json`ç±»å‹
  - `text/plain`ï¼šè¡¨ç¤ºæ˜¯æ–‡æœ¬ç±»å‹
  - `application/xml`ï¼šè¡¨ç¤ºæ˜¯ `xml` ç±»å‹
  - `multipart/form-data`ï¼šè¡¨ç¤ºæ˜¯ä¸Šä¼ æ–‡ä»¶
- `content-length`ï¼šæ–‡ä»¶çš„å¤§å°é•¿åº¦
- `keep-alive`ï¼š
  - `http` æ˜¯åŸºäº `TCP` åè®®çš„ï¼Œä½†æ˜¯é€šå¸¸åœ¨è¿›è¡Œä¸€æ¬¡è¯·æ±‚å’Œå“åº”ç»“æŸåä¼šç«‹åˆ»ä¸­æ–­
  - åœ¨ `http1.0` ä¸­ï¼Œå¦‚æœæƒ³è¦ç»§ç»­ä¿æŒè¿æ¥ï¼š
    1. æµè§ˆå™¨éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  `connection: keep-alive`
    2. æœåŠ¡å™¨éœ€è¦åœ¨å“åº”å¤´ä¸­æ·»åŠ  `connection: keey-alive`
    3. å½“å®¢æˆ·ç«¯å†æ¬¡æ”¾è¯·æ±‚æ—¶ï¼Œå°±ä¼šä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ï¼Œç›´æ¥ä¸€æ–¹ä¸­æ–­è¿æ¥
  - åœ¨ `http1.1` ä¸­ï¼Œæ‰€æœ‰è¿æ¥é»˜è®¤æ˜¯ `connection: keep-alive` çš„
    - ä¸åŒçš„ `Web` æœåŠ¡å™¨ä¼šæœ‰ä¸åŒçš„ä¿æŒ `keep-alive` çš„æ—¶é—´
    - `Node` ä¸­é»˜è®¤æ˜¯ `5s` 
- **`accept-encoding`ï¼šå‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯æ”¯æŒçš„æ–‡ä»¶å‹ç¼©æ ¼å¼**ï¼Œæ¯”å¦‚ `js` æ–‡ä»¶å¯ä»¥ä½¿ç”¨ `gzip` ç¼–ç ï¼Œå¯¹åº” `.gz`æ–‡ä»¶ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥æ ¹æ®å®¢æˆ·ç«¯æ”¯æŒçš„å‹ç¼©æ ¼å¼è¿”å›å¯¹åº”çš„å‹ç¼©æ–‡ä»¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è§£å‹è¯¥æ–‡ä»¶ï¼Œä»è€Œæé«˜ç½‘ç»œä¸Šçš„ä¼ è¾“é€Ÿåº¦
- **`accept`ï¼šå‘ŠçŸ¥æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å¯æ¥å—æ–‡ä»¶çš„æ ¼å¼ç±»å‹**
- `user-agent`ï¼šå®¢æˆ·ç«¯ç›¸å…³çš„ä¿¡æ¯





# å››. responseå“åº”å¯¹è±¡

---

## 1. è¿”å›å“åº”ç»“æœ

- å¦‚æœæˆ‘ä»¬å¸Œæœ›ç»™å®¢æˆ·ç«¯å“åº”çš„ç»“æœæ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼ï¼š

  - `Write` æ–¹æ³•ï¼šè¿™ç§æ–¹å¼æ˜¯ç›´æ¥å†™å‡ºæ•°æ®ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…³é—­æµ
  - `end` æ–¹æ³•ï¼šè¿™ç§æ–¹å¼æ˜¯å†™å‡ºæœ€åçš„æ•°æ®ï¼Œå¹¶ä¸”å†™å‡ºåä¼šå…³é—­æµ

- æ­£å¸¸çš„å†™å…¥æµæ˜¯å¯ä»¥è°ƒç”¨ `close` çš„ï¼Œ`Writeable` å†…éƒ¨æºç ä¸è®©è°ƒç”¨ `close` æ–¹æ³•

- å¦‚æœæˆ‘ä»¬æ²¡æœ‰è°ƒç”¨ `end` æ–¹æ³•ï¼Œå®¢æˆ·ç«¯å°†ä¼šä¸€ç›´ç­‰å¾…ç»“æœï¼š

  - æ‰€ä»¥å®¢æˆ·ç«¯åœ¨å‘é€ç½‘ç»œè¯·æ±‚æ—¶ï¼Œéƒ½ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ `timeout`

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    // res: responseå¯¹è±¡ -> Writeableå¯å†™æµ
    // 1.å“åº”æ•°æ®æ–¹å¼ä¸€ï¼šwrite
    res.write('hello world')
    res.write('hehe')
  
    // 2.å“åº”æ•°æ®æ–¹å¼äºŒï¼šend
    // res.close() // ä¼šæŠ¥é”™ï¼Œæ­£å¸¸çš„å†™å…¥æµæ˜¯å¯ä»¥è°ƒç”¨closeçš„ï¼ŒWriteableå†…éƒ¨ä¸è®©è°ƒç”¨closeæ–¹æ³•
    res.end('hello world~ ğŸš€ğŸš€ğŸš€')
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')
  })
  ```

## 2. è¿”å›çŠ¶æ€ç ï¼ˆhttpå“åº”çŠ¶æ€ç ï¼‰

- `Http` çŠ¶æ€ç ï¼ˆ`Http Status Code`ï¼‰æ˜¯ç”¨æ¥è¡¨ç¤º `Http` å“åº”çŠ¶æ€çš„æ•°å­—ä»£ç ï¼š
  - `Http` çŠ¶æ€ç éå¸¸å¤šï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œç»™å®¢æˆ·ç«¯è¿”å›ä¸åŒçš„çŠ¶æ€ç 
  - `MDN` å“åº”ç è§£æåœ°å€ï¼šhttps://developer.mozilla.org/zh-CN/docs/web/http/status

| å¸¸è§HTTPçŠ¶æ€ç  | çŠ¶æ€æè¿°              | ä¿¡æ¯è¯´æ˜                                                     |
| -------------- | --------------------- | ------------------------------------------------------------ |
| 200            | OK                    | å®¢æˆ·ç«¯è¯·æ±‚æˆåŠŸ                                               |
| 201            | Created               | è¯¥è¯·æ±‚å·²æˆåŠŸï¼Œå¹¶å› æ­¤åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„èµ„æºã€‚è¿™é€šå¸¸æ˜¯åœ¨ POST è¯·æ±‚ï¼Œæˆ–æ˜¯æŸäº› PUT è¯·æ±‚ä¹‹åè¿”å›çš„å“åº” |
| 301            | Moved Permanently     | è¯·æ±‚èµ„æºçš„ URL å·²ä¿®æ”¹ã€‚åœ¨å“åº”ä¸­ä¼šç»™å‡ºæ–°çš„ URL                |
| 400            | Bad Request           | ç”±äºè¢«è®¤ä¸ºæ˜¯å®¢æˆ·ç«¯é”™è¯¯ï¼ˆä¾‹å¦‚ï¼Œé”™è¯¯çš„è¯·æ±‚è¯­æ³•ã€æ— æ•ˆçš„è¯·æ±‚æ¶ˆæ¯å¸§æˆ–æ¬ºéª—æ€§çš„è¯·æ±‚è·¯ç”±ï¼‰ï¼ŒæœåŠ¡å™¨æ— æ³•æˆ–ä¸ä¼šå¤„ç†è¯·æ±‚å®¢æˆ·ç«¯ |
| 401            | Unauthorized          | æœªæˆæƒçš„é”™è¯¯ï¼Œå®¢æˆ·ç«¯å¿…é¡»æºå¸¦è¯·æ±‚çš„èº«ä»½ä¿¡æ¯                   |
| 403            | Forbidden             | å®¢æˆ·ç«¯æ²¡æœ‰è®¿é—®æƒé™ï¼›æœªç»æˆæƒçš„ï¼Œå› æ­¤æœåŠ¡å™¨æ‹’ç»æä¾›è¯·æ±‚çš„èµ„æº |
| 404            | Not Found             | æœåŠ¡å™¨æ‰¾ä¸åˆ°è¯·æ±‚çš„èµ„æº                                       |
| 500            | Internal Server Error | æœåŠ¡å™¨é‡åˆ°äº†ä¸çŸ¥é“å¦‚ä½•å¤„ç†çš„æƒ…å†µ                             |
| 503            | Service Unavailable   | æœåŠ¡å™¨æ²¡æœ‰å‡†å¤‡å¥½å¤„ç†è¯·æ±‚ã€‚å¸¸è§åŸå› æ˜¯æœåŠ¡å™¨å› ç»´æŠ¤æˆ–é‡è½½è€Œåœæœº |

```js
const http = require('http')

const server = http.createServer((req, res) => {
  // å“åº”çŠ¶æ€ç 
  // 1.æ–¹å¼ä¸€ï¼šstatusCode
  // res.statusCode = 201
  // res.end('åˆ›å»ºèµ„æºæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')

  // res.statusCode = 403
  // res.end('å®¢æˆ·ç«¯æ²¡æœ‰è®¿é—®æƒé™~ ğŸš€ğŸš€ğŸš€')

  // 2.æ–¹å¼äºŒï¼šsetHeadå“åº”å¤´
  res.writeHead(401)
  res.end('æœªæˆæƒï¼Œè¯·æºå¸¦èº«ä»½ä¿¡æ¯~ ğŸš€ğŸš€ğŸš€')
})

server.listen(8000, () => {
  console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')
})
```

## 3. å“åº”å¤´æ–‡ä»¶

- è¿”å›å¤´éƒ¨ä¿¡æ¯ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

  - `res.setHeader`ï¼šä¸€æ¬¡å†™å…¥ä¸€ä¸ªå¤´éƒ¨ä¿¡æ¯
  - `res.writeHead`ï¼šåŒæ—¶å†™å…¥ `header` å’Œ `status`

  ```js
  const http = require('http')
  
  const server = http.createServer((req, res) => {
    // è®¾ç½®headerä¿¡æ¯: æ•°æ®çš„ç±»å‹ä»¥åŠæ•°æ®çš„ç¼–ç æ ¼å¼
    // æµè§ˆå™¨é»˜è®¤çš„ç¼–ç æ ¼å¼ï¼Œæ˜¯æ— æ³•è§£æä¸­æ–‡çš„ï¼Œæ‰€ä»¥éœ€è¦åœ¨å“åº”å¤´ä¸­è®¾ç½®utf-8çš„ç¼–ç æ ¼å¼
    // å½“ç¼–ç æ ¼å¼ä¸æ­£ç¡®ï¼Œæµè§ˆå™¨æ— æ³•è§£ææ—¶ï¼Œå°±ä¼šç›´æ¥ä¸‹è½½æ–‡ä»¶
    // 1.å•ç‹¬è®¾ç½®æŸä¸€ä¸ªheader
    res.setHeader('Content-Type', 'text/plain;charset=utf8;')
    // res.end('hello world ä½ å¥½å•Š ~ ğŸš€ğŸš€ğŸš€')
  
    res.setHeader('Content-Type', 'application/json;charset=utf8;')
  
    // 2.å’Œhttp statusCodeä¸€å—è®¾ç½®
    res.writeHead(200, {
      'Content-Type': 'application/json;chartset=utf8;',
    })
  
    const data = {
      name: 'later-zc',
      age: 18,
    }
    res.end(JSON.stringify(data))
    // res.end('{"name": "later-zc"}')
  })
  
  server.listen(8000, () => {
    console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')
  })
  ```

- `Header` è®¾ç½® `Content-Type` æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ

  - é»˜è®¤å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„æ˜¯å­—ç¬¦ä¸²ï¼Œå®¢æˆ·ç«¯ä¼šæŒ‰ç…§è‡ªå·±é»˜è®¤çš„æ–¹å¼è¿›è¡Œå¤„ç†

  <img src="assets/image-20230205122501739.png" alt="image-20230205122501739" style="zoom:80%;" />





# äº”. axios nodeä¸­ä½¿ç”¨

---

- `axios` åº“å¯ä»¥åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨ `Node` ä¸­ä½¿ç”¨ï¼š

  - åœ¨æµè§ˆå™¨ä¸­ï¼Œ`axios` ä½¿ç”¨çš„æ˜¯å°è£… `xhr`ï¼ˆ`XMLHttpRequeust`ï¼‰
  - åœ¨ `Node` ä¸­ï¼Œ`axios` ä½¿ç”¨çš„æ˜¯ `http` å†…ç½®æ¨¡å—

- `http` å‘é€ç½‘ç»œè¯·æ±‚( `axios` åœ¨ `node` ä¸­çš„æœ¬è´¨)ï¼š

  <img src="assets/image-20230205124423065.png" alt="image-20230205124423065" style="zoom:80%;" />

```js
const http = require('http')

// 1.ä½¿ç”¨httpæ¨¡å—å‘é€getè¯·æ±‚
// http.get('http://localhost:8000', (res) => {
//   // ä»å¯è¯»æµä¸­è·å–æ•°æ®
//   res.setEncoding('utf-8')
//   res.on('data', (data) => {
//     console.log('data: ', JSON.parse(data))
//   })
// })

// 2.ä½¿ç”¨httpæ¨¡å—å‘é€postè¯·æ±‚
// httpæ¨¡å—æ²¡æœ‰æä¾›ç›´æ¥çš„postæ–¹æ³•
const req = http.request(
  {
    method: 'POST',
    hostname: 'localhost',
    port: 8000,
  },
  (res) => {
    res.on('data', (data) => {
      console.log('data: ', data.toString())
    })
  }
)

// å¿…é¡»è°ƒç”¨endï¼Œè¡¨ç¤ºå†™å…¥å†…å®¹å®Œæˆ
req.end()
```

```js
const axios = require('axios')

axios.get('http://localhost:8000').then((res) => {
  console.log('res.data: ', res.data)
})
```





# å…­. æ–‡ä»¶ä¸Šä¼ çš„ç»†èŠ‚åˆ†æ

---

## 1. æ–‡ä»¶ä¸Šä¼  â€“ é”™è¯¯ç¤ºèŒƒ

```js
const http = require('http')
const fs = require('fs')

const server = http.createServer((req, res) => {
  const writeStream = fs.createWriteStream('./foo.png', {
    flags: 'a+',
  })

  // req.pipe(writeStream) // å¯è¯»æµä¸­æœ‰äº›æ•°æ®ä¸èƒ½è¢«æ”¾å…¥åˆ°å¯å†™æµä¸­

  req.on('data', (data) => {
    console.log('data: ', data)
    writeStream.write(data)
  })

  req.on('end', () => {
    writeStream.close()
    res.end('ä¸Šä¼ å®Œæˆ~')
  })
})

server.listen(8000, () => {
  console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ~ ğŸš€ğŸš€ğŸš€')
})
```

- å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„ä¸ä»…ä»…åªæœ‰å›¾ç‰‡æ•°æ®ï¼Œè¿˜åŒ…å«äº†è¡¨å•æ•°æ®ï¼Œæ‰€ä»¥å½“è¿™äº›ä¿¡æ¯æ··åˆåœ¨ä¸€èµ·ä½œä¸ºä¸€ä¸ª `png` çš„å›¾ç‰‡æ—¶ï¼Œæ ¼å¼ä¸æ­£ç¡®ä»è€Œæ— æ³•è¢«è§£æçš„

## 2. æ–‡ä»¶ä¸Šä¼  â€“ æ­£ç¡®åšæ³•

```js
const http = require('http')
const fs = require('fs')
const qs = require('querystring')

const server = http.createServer((req, res) => {
  // å›¾ç‰‡æ–‡ä»¶å¿…é¡»è®¾ç½®ä¸ºäºŒè¿›åˆ¶çš„
  req.setEncoding('binary')

  // è·å–content-typeä¸­çš„boundaryçš„å€¼
  const boundary = req.headers['content-type'].split('; ')[1].replace('boundary=', '')

  // è®°å½•å½“å‰æ•°æ®çš„ä¿¡æ¯
  const fileSize = req.headers['content-length']
  let curSize = 0
  // æ–‡ä»¶ä¸Šä¼ ä¸€èˆ¬é€šè¿‡è¡¨å•çš„å½¢å¼ï¼Œæ•°æ®ç±»å‹ä¸ºmultipart/form-data;
  let formData = ''

  // ç›‘å¬å½“å‰çš„æ•°æ®
  req.on('data', (data) => {
    curSize += data.length
    res.write(`æ–‡ä»¶ä¸Šä¼ è¿›åº¦ï¼š${(curSize / fileSize) * 100}% ğŸš€\n`)
    formData += data
  })

  req.on('end', () => {
    // 1.ä»image/pngä½ç½®å¼€å§‹æˆªå–åˆ°åé¢æ‰€æœ‰çš„æ•°æ®
    // æˆªå–ç¬¦å·ç”±'&' -> '\r\n'
    // åˆ†å‰²ç¬¦å·ç”±'=' -> ':'
    const payload = qs.parse(formData, '\r\n', ':')
    // è·å–æœ€åçš„ç±»å‹(image/png)
    const fileType = payload['Content-Type'].substring(1)
    // è·å–è¦æˆªå–çš„é•¿åº¦
    const fileTypePosition = formData.indexOf(fileType) + fileType.length
    let binaryData = formData.substring(fileTypePosition)

    // 2.binaryDataå¼€å§‹ä½ç½®ä¼šæœ‰ä¸¤ä¸ªç©ºæ ¼
    binaryData = binaryData.replace(/^\s\s*/, '')

    // 3.æ›¿æ¢æœ€åçš„boundary
    binaryData = binaryData.substring(0, binaryData.indexOf(`--${boundary}--`))

    // 4.å°†binaryDataæ•°æ®å­˜å…¥æ–‡ä»¶ä¸­
    fs.writeFile('./bar.png', binaryData, 'binary', (err) => {
      console.log('err: ', err)
      res.end('file upload complete ğŸš€ğŸš€ğŸš€~')
    })
  })
})

server.listen(8000, () => {
  console.log('æœåŠ¡å™¨è¿è¡ŒæˆåŠŸ ~ ğŸš€ğŸš€ğŸš€')
})
```

## 3. æ–‡ä»¶ä¸Šä¼  - æµè§ˆå™¨ä»£ç 

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>

  <input type="file">
  <button>upload</button>

  <script>
    // æ–‡ä»¶ä¸Šä¼ çš„é€»è¾‘
    const btnEl = document.querySelector('button')
    btnEl.onclick = function () {
      // 1.åˆ›å»ºè¡¨å•å¯¹è±¡
      const formData = new FormData()

      // 2.å°†é€‰ä¸­çš„å›¾ç‰‡æ–‡ä»¶æ”¾å…¥è¡¨å•ä¸­
      const inputEl = document.querySelector('input')
      formData.set('img', inputEl.files[0])

      // 3.å‘é€postè¯·æ±‚ï¼Œå°†è¡¨å•æ•°æ®æºå¸¦åˆ°æœåŠ¡å™¨
      axios({
        method: 'post',
        url: 'http://localhost:8000',
        data: formData,
        headers: {
          'Content-Type': 'multipart/form-data'
        }
      })
    }
  </script>
</body>
</html>
```

















