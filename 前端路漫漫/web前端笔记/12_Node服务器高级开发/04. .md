# 一. koa 的基本使用

---

## 1. 认识 Koa

- 前面我们已经学习了 `express`，另外一个非常流行的 `Node Web` 服务器框架就是 `Koa`
- `Koa`官方的介绍：
  - koa: next generation web framework for node.js
  - koa: `node.js` 的下一代 `web` 框架
- 事实上，`koa` 是 `express` 同一个团队开发的一个新的 `Web` 框架：
  - 目前团队的核心开发者 `TJ` 的主要精力也在维护 `Koa`，`express` 已经交给团队维护了
  - `Koa` 旨在为 `Web` 应用程序和 `API` 提供更小、更丰富和更强大的能力
  - **`koa` 相对于 `express` 具有更强的异步处理能力**
  - `Koa` 的核心代码只有 `1600+` 行，**是一个更加轻量级的框架**
  - 我们可以根据需要安装和使用中间件
- 事实上学习了 `express` 之后，学习 `koa` 的过程是很简单的

## 2. Koa 初体验

- 我们来体验一下 `koa` 的 `Web` 服务器，创建一个接口

  - `koa` 也是通过注册中间件来完成请求操作的

- `koa` 注册的中间件提供了两个参数：

- `ctx`：上下文（`Context`）对象

  - `koa` 并没有像 `express` 一样，将 `req` 和 `res` 分开，而是将它们作为 `ctx` 的属性
  - `ctx` 代表一次请求的上下文对象
  - `ctx.request`：获取请求对象
  - `ctx.response`：获取响应对象

- `next`：本质上是一个 `dispatch`，类似于之前的 `next`

  - 后续我们学习 `Koa` 的源码，来看一下它是一个怎么样的函数

  ```js
  const Koa = require('koa')
  // koa在没有提供对应的服务时，koa没有像express那样提供一个对应的页面
  const app = new Koa()
  
  // 注册中间件(middleware)
  // koa中间件有两个参数：ctx/next
  app.use((ctx, next) => {
    // 1.请求对象
    // ctx.request：koa封装的请求对象
    console.log('ctx.request: ', ctx.request)
    // ctx.req: node封装的请求对象(http.createServer中的请求对象)
    console.log('ctx.req: ', ctx.req)
  
    // 2.响应对象
    // ctx.response: koa封装的响应对象
    console.log('ctx.response: ', ctx.response)
    // ctx.res: node封装的响应对象(http.createServer中的响应对象)
    console.log('ctx.res: ', ctx.res)
  
    // 3.其他属性
    console.log('ctx.query: ', ctx.query)
    next()
  })
  
  app.use(() => {
    console.log('hello world~')
  })
  
  app.listen(6000, () => {
    console.log('koa server running~')
  })
  // koa在没有提供对应的服务时，koa没有像express那样提供一个对应的页面，而是返回Not Found
  ```
  

## 3. Koa 中间件

- `koa` 通过创建的 `app` 对象，注册中间件只能通过 `use` 方法：

  - **`Koa` 并没有提供 `methods` 的方式来注册中间件**
  - **也没有提供 `path` 中间件来匹配路径**

- 但是真实开发中我们如何将路径和 `method` 分离呢？

  - 方式一：根据 `request` 自己来判断

    ```js
    const Koa = require('koa')
    const app = new Koa()
    
    app.use((ctx, next) => {
      const { path, request, method } = ctx
      console.log(path === request.path) // true
      const mtd = method == 'GET' ? 'GET' : 'POST'
      switch (path) {
        case '/users':
          ctx.body = `${mtd} users`
          break
        case '/home':
          ctx.body = `${mtd} home`
          break
        case '/login':
          ctx.body = `${mtd} login`
          break
      }
    })
    
    app.listen(6000, () => {
      console.log('koa server running~')
    })
    ```

  - 方式二：使用第三方路由中间件（看下一节）

## 4. 路由的使用

- `koa` 官方并没有给我们提供路由的库，我们可以选择第三方库`@koa/router`

  ```bash
  npm i @koa/router
  ```

- 我们可以先封装一个 `userRouter.js` 的文件：

  ```js
  // ./router/userRouter.js
  const KoaRouter = require('@koa/router')
  
  // 1.创建路由对象
  const userRouter = new KoaRouter({
    prefix: '/users',
  })
  
  // 2.在路由中注册中间件：path/method
  userRouter.get('/', (ctx, next) => {
    ctx.body = 'users 01'
  })
  userRouter.get('/:id', (ctx, next) => {
    const { id } = ctx.params
    ctx.body = '获取某一个用户' + id
  })
  userRouter.post('/', (ctx, next) => {
    ctx.body = '创建用户成功'
  })
  userRouter.delete('/:id', (ctx, next) => {
    const { id } = ctx.params
    ctx.body = '删除某一个用户' + id
  })
  userRouter.patch('/:id', (ctx, next) => {
    const { id } = ctx.params
    ctx.body = '修改某一个用户' + id
  })
  
  module.exports = userRouter
  ```

- 在 `app` 中将 `router.routes()` 注册为中间件：

  ```js
  const Koa = require('koa')
  const userRouter = require('./router/userRouter')
  
  const app = new Koa()
  
  // 3.让路由中的中间件生效
  app.use(userRouter.routes())
  app.use(userRouter.allowedMethods())
  
  app.listen(6000, () => {
    console.log('koa server running~')
  })
  ```

> **注意：**
>
> - **`allowedMethods` 用于判断某一个 `method` 是否支持：**
>
> - **如果我们请求 `get`，那么是正常的请求，因为我们有实现 `get`** 
> - **如果我们请求 `put`、`delete`、`patch`，会自动报错：`Method Not Allowed`，状态码：405**
> - **如果我们请求 `link`、`copy`、`lock`，会自动报错：`Not Implemented`，状态码：501**







# 二. koa 的参数解析

---



















# 三. koa 响应和错误

---



















# 四. koa 静态服务器

---















# 五. koa 的源码解析

---











# 六. 和 express 对比

---



















