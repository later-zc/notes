

# 一. 项目介绍和搭建

---

## 1. coderhub 功能接口说明

- `Coderhub` 旨在创建一个程序员分享生活动态的平台

  <img src="assets/06_后台项目的接口类型分析.png" alt="06_后台项目的接口类型分析" style="zoom:80%;" />

- 完整的项目接口包括：

  - 面向用户的业务接口
  - 面向企业或者内部的后台管理接口

- 课堂上完成的功能如下：

  1. 用户管理系统
  2. 内容管理系统
  3. 内容评论管理
  4. 内容标签管理
  5. 文件管理系统
  6. 其他功能其实都是非常相似的

## 2. 项目的搭建

- 功能一：目录结构的划分：
  - 按照功能模块划分
  - 按照业务模块划分
  
- 功能二：应用配置信息写到环境变量
  - 编写 `.env` 文件
  
  - 通过 `dotenv` 库加载 `env` 文件配置的变量
  
    ```shell
    npm i dotenv
    ```
  
    ```js
    const dotenv = require('dotenv')
    
    // 可以配置path，但是默认会加载当前项目下面的根目录的.env文件
    dotenv.config()
    ```
  
- 功能三：创建和启动服务器

  - 基于 `koa` 创建 `app`
  - 启动服务器





# 二. 注册接口的逻辑

---

## 1. 用户注册接口

- 用户注册接口编写流程：
  - 注册用户路由 `router` 编写
  - 处理函数的控制器 `controller` 编写
  - 操作数据库的 `service` 编写
  
- 数据库连接操作：`mysql2`

  ```bash
  npm i mysql2
  ```

  - 创建数据库连接
  - 测试数据库连接是否成功

- 注册用户校验
  - 用户名或密码不能为空
  - 用户名没有被注册过

- 通过使用 `node` 内置模块 `crypto` 对用户密码进行 `md5` 加密存储

  ```js
  const crypto = require('node:crypto')
  
  function md5Password(key) {
    const md5 = crypto.createHash('md5')
    return md5.update(key).digest('hex')
  }
  
  module.exports = {
    md5Password,
  }
  ```

## 2. 错误统一处理

- 封装错误处理函数，`App` 监听错误事件：

  ```js
  const app = require('../app')
  const {
    USERNAME_IS_ALREADY_EXIST,
    USERNAME_OR_PASSWORD_NOT_NULL,
  } = require('../config/error.constants')
  
  app.on('error', (error, ctx) => {
    switch (error) {
      case USERNAME_OR_PASSWORD_NOT_NULL:
        ctx.body = {
          code: -1001,
          message: error,
        }
        break
      case USERNAME_IS_ALREADY_EXIST:
        ctx.body = {
          code: -1002,
          message: error,
        }
    }
  })
  ```





# 三. 登录用户的凭证

---

## 1. 用户登录接口

- 用户登录接口编写流程：
  - 授权 `router` 的编写
  - 处理函数的 `controller` 编写
- 验证的中间件：
  - 账号和密码是否为空
  - 用户名是否存在
  - 校验密码是否一致
- 登录成功返回凭证：
  - `cookie` + `session`
  - `Token` 令牌

## 2. 为什么需要登录凭证呢？

- `web` 开发中，我们使用最多的协议是 `http`，但是 **`http` 是一个无状态的协议**
  - 无状态的协议？什么叫做无状态协议呢？
- 举个例子：
- 我们登录了一个网站 www.coderhub.com
- 登录的时候我们需要输入用户名和密码：比如用户名 `coder1`，密码：666
- 登录成功之后，我们要以 `coder1` 的身份去访问其他的数据和资源，还是通过 `http` 请求去访问
  - `coderhub`服务器会问：你谁呀？
  - `coder1` 说：我是 `coder1` 呀，刚刚登录过呀
  - `coderhub`服务器：怎么证明你刚刚登录过呀？
  - `coder1` 说：这...，`http` 没有告诉你吗？
  - `coderhub`服务器：`http` 的每次请求对我来说都是一个单独的请求，和之前请求过什么没有关系
- 看到了吧？这就是 `http` 的无状态，也就是服务器不知道你上一步做了什么，我们必须得有一个办法可以证明我们登录过

## 3. 认识 cookie

- `Cookie`，又称为 '小甜饼'。类型为 '小型文本文件'，某些网站为了辨别用户身份而**存储在用户本地终端（`Client Side`）上的数据**
  - 浏览器会在特定的情况下携带上 `cookie` 来发送请求，我们可以通过 `cookie` 来获取一些信息
  - 浏览器发送请求时，在请求头上自动携带上 `cookie`
- `Cookie` 总是保存在客户端中，根据其客户端中的存储位置，`Cookie` 可以分为内存 `Cookie` 和硬盘 `Cookie`
  - 内存 `Cookie` （会话 `cookie`）由浏览器维护，保存在内存中，浏览器关闭时 `Cookie` 就会消失，其存在时间是短暂的
  - 硬盘 `Cookie` 保存在硬盘中，有一个过期时间，用户手动清理或者过期时间到时，才会被清理
- 如何判断一个 `cookie` 是内存 `cookie` 还是硬盘 `cookie` 呢？
  - 没有设置过期时间，默认情况下 `cookie` 是内存 `cookie`，在关闭浏览器时会自动删除
  - 有设置过期时间，并且过期时间不为 `0` 或者负数的 `cookie`，是硬盘 `cookie`，需要手动或者到期时，才会删除









# 四. 发表动态和评论

---











# 五. 动态的标签接口

---











# 六. 图片上传和存储

---

















